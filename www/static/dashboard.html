<html>
<head>
  <link rel="stylesheet" href="css/blueprint/screen.css" type="text/css" media="screen, projection"/>
  <link rel="stylesheet" href="css/blueprint/print.css" type="text/css" media="print" /> 
  <!--[if lt IE 8]>
  <link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection" />
  <![endif]-->

  <link rel="stylesheet" href="css/colorbox/colorbox.css" type="text/css" /> 
  <link rel="stylesheet" href="css/index.css" type="text/css" /> 

  <script src="js/template.js"></script>
  <script src="js/template-common.js"></script>
  <link rel="import" href="./templates/common.html" onload="loadCommon(event)">
</head>
<body>
  <div id="header"></div>

  <div class="container" style="border-bottom:1px solid #ccc; margin-bottom:1em; padding-top:0.25em; padding-bottom:0.25em;">
    <div id="vehicleMenu" class="span-18">
      <a href="dashboard.html"><img src="img/fugue/dashboard.png" class="icon" /> Dashboard</a> | 
      <a href="mileage.html"><img src="img/fugue/counter.png" class="icon" /> Mileage</a> | 
      <a href="maintenance.html"><img src="img/fugue/wrench.png" class="icon" /> Maintenance</a> | 
      <a href="events.html"><img src="img/fugue/sticky-note.png" class="icon" /> Events</a>
    </div>
    <div class="span-6 last" style="text-align:right;">
    </div>
  </div>

  <div id="dashboard" class="container">
    <div class="span-24 last">
      <h2>Cost Summary</h2>
    </div>

    <div class="span-24 last">
      <div id="fuelCostSummary" class="span-12"></div>
      <div id="maintenanceCostSummary" class="span-12 last"></div>
    </div>

    <div class="span-24 last">
      <h2>Vehicle Estimates</h2>
    </div>

    <div class="span-24 last">
      <div id="tankSize" class="span-8"></div>
      <div id="mpg" class="span-8"></div>
      <div id="range" class="span-8 last"></div>
    </div>

    <div class="span-24 last">
      <h2>Inferred Economy</h2>
    </div>

    <div class="span-24 last">
      <div id="ppm" class="span-8"></div>
      <div id="fuelCosts" class="span-8"></div>
      <div id="ppd" class="span-8 last"></div>
    </div>
  </div>

  <div id="footer"></div>

  <template id="summaryTile-template">
    <div style="text-align:center;">
      <h3 id="heading"></h3>
      <div id="total" style="font-weight: bold; background-color: #efd; border: 1px solid #dec; font-size: 1.5em; margin-bottom: 1em;"></div>
      <canvas id="chart" height="150"></canvas>
    </div>
  </template>

  <template id="estimateTile-template">
    <div style="text-align:center;">
      <h3 id="heading"></h3>
      <div id="mean" style="font-weight: bold; background-color: #efd; border: 1px solid #dec; font-size: 1.5em;"></div>
      <span id="confidenceInterval" class="small quiet"></span>
      <span id="unit" class="small quiet"></span>
      <canvas id="chart" height="150"></canvas>
    </div>
  </template>

  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.6.4/jquery.colorbox-min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>

  <script src="js/common.js"></script>
  <script src="js/crud.js"></script> 
  <script src="js/figures.js"></script> 

  <script type="text/javascript">
	function tileBarChart(canvasEl, def) {
		var ctx = canvasEl.getContext("2d")
		var chart = new Chart(ctx, {
			type: 'bar',
			data : {
				labels: def.binCenters.map(function(x) {
					return round(x, def.numDigits)
				}),
				datasets: [{
					data : def.binCounts,
					yAxisID : "freqYAxis",
					borderColor: "#333",
					backgroundColor: "#999"
				}, {
					type : 'line',
					data : def.fit,
					yAxisID : "fitYAxis",
					borderColor: "#f00",
					fill: false,
					pointRadius: 0
				}]
			},
			options : {
				legend: {
					display: false
				},
				scales: {
					xAxes: [{
						gridLines: {
							display: false
						},
						scaleLabel: {
							labelString: def.xLabel,
							display: true
						}
					}],
					yAxes: [{
						"id" : "freqYAxis",
						position: "left",
						scaleLabel: {
							labelString: def.yLabel,
							display: true
						}
					}, {
						"id" : "fitYAxis",
						position: "right",
						display: false
					}]
				}
			}
		});
	}

	function populateCostSummaryTile(clone, data, heading) {
		data.total = round(data.total, 2);

		for(var i = 0; i < data.dateTotals.length; ++i) {
			data.dateTotals[i] = round(data.dateTotals[i], 2)
		}

		clone.querySelector("#heading").innerHTML = heading;
		clone.querySelector("#total").innerHTML = "$" + data.total;

		tileBarChart(clone.querySelector("#chart"), {
			binCenters: data.dateBins,
			binCounts: data.dateTotals,
			numDigits: 0,
			xLabel: "Date",
			yLabel: "Total ($)"
		});
	}

	function populateEstimateTile(clone, data, heading, unit, numDigits) {
		data.params.loc = round(data.params.loc, numDigits);
		data.params.interval[0] = round(data.params.interval[0], numDigits);
		data.params.interval[1] = round(data.params.interval[1], numDigits);

		clone.querySelector("#heading").innerHTML = heading;
		clone.querySelector("#mean").innerHTML = data.params.loc;
		clone.querySelector("#confidenceInterval").innerHTML = "95% CI: " + data.params.interval[0] + " - " + data.params.interval[1];
		clone.querySelector("#unit").innerHTML = unit;

		tileBarChart(clone.querySelector("#chart"), {
			binCenters: data.binCenters,
			binCounts: data.binCounts,
			fit : data.fit,
			numDigits: numDigits,
			xLabel: heading + " " + unit,
			yLabel: "Frequency"
		});
	}
	
	$(document).ready(function() {
		var params = new URLSearchParams(document.location.search)
		var vehicleId = params.get("id")
		$("#vehicleMenu").find("a").each(function(){
			$(this).attr("href", $(this).attr("href") + "?id=" + vehicleId)
		});

		$.ajax({
			method : "GET",
			url : "/rest/vehicles/" + vehicleId + "/costSummary",
			success : function(results) {
				tileIds = ["#fuelCostSummary", "#maintenanceCostSummary"];
				headings = ["Fuel", "Maintenance"]
				data = [results.fuel, results.maintenance];

				for(var i = 0; i < 2; ++i) {
					var template = document.querySelector("#summaryTile-template")
					var placeholder = document.querySelector(tileIds[i])
					var clone = document.importNode(template.content, true)
					populateCostSummaryTile(clone, data[i], headings[i]);
					placeholder.appendChild(clone)
				}
			}
		});

		$.ajax({
			method : "GET",
			url : "/rest/vehicles/" + vehicleId + "/estimates",
			success : function(results) {
				tileIds = ["#tankSize", "#mpg", "#range", "#ppm", "#fuelCosts", "#ppd"];
				data = [results.tank, results.mpg, results.range, results.ppm, results.fuelCosts, results.ppd];
				headings = ["Refill", "Fuel Economy", "Range", "Price Per Mile", "Refill Cost", "Price Per Day"]
				units = ["(gal)", "(mi/gal)", "(mi)", "($/mi)", "($)", "($/day)"]
				numDigits = [ 1, 1, 1, 3, 2, 2];

				for(var i = 0; i < 6; ++i) { 
					var template = document.querySelector("#estimateTile-template")
					var placeholder = document.querySelector(tileIds[i])
					var clone = document.importNode(template.content, true)
					populateEstimateTile(clone, data[i], headings[i], units[i], numDigits[i])
					placeholder.appendChild(clone)
				}
			}
		});
	});
  </script>
</body>
</html>
