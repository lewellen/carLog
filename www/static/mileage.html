<html>
  <head>
    <link rel="stylesheet" href="css/blueprint/screen.css" type="text/css" media="screen, projection">
    <link rel="stylesheet" href="css/blueprint/print.css" type="text/css" media="print"> 
    <!--[if lt IE 8]>
    <link rel="stylesheet" href="css/blueprint/ie.css" type="text/css" media="screen, projection">
    <![endif]-->

    <link rel="stylesheet" href="css/colorbox/colorbox.css" type="text/css"> 
 
    <link rel="stylesheet" href="css/index.css" type="text/css"> 

    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.2.1/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jquery.colorbox/1.6.4/jquery.colorbox-min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/2.5.0/Chart.bundle.min.js"></script>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/vue/2.3.0/vue.js"></script>
    <title>CarLog</title>
  </head>
  <body>

  <script type="text/javascript">
	$(document).ready(function() {

		$(".submit").click(function(e) {
			e.preventDefault();

			formArray = $('form').serializeArray();
			var obj = { };
			for(var i = 0, len = formArray.length; i < len; ++i) {
				obj[formArray[i]["name"]] = formArray[i]["value"];
			}

			$.ajax({
				type : "POST",
				url : this.href,
				data : JSON.stringify(obj),
				contentType: "application/json",
				success : function(result) {
					if(result.id == null) {
						$("#formMessageBox").text(result.msg);
						$("#formMessageBox").addClass("notice");
					} else {
						$("#messageBox").text("Success!");
						$("#messageBox").addClass("success");
						$.colorbox.close();
					}
				},
				fail : function(result) {
					$("#formMessageBox").text(result.msg);
					$("#formMessageBox").addClass("error");
				}
			});
		});

		$("#addEntry").colorbox({
			inline : true,
			onClosed : function() {
				location.reload();
			}
		});

		$.ajax({
			url: "/rest/vehicles/1/mileage",
			timeout: 3000,
			success : function(mileage) {
				new Chart(document.getElementById("mileageChart"), {
					type: 'line',
					data: {
						labels: mileage.map(function(entry) {
							return new Date(entry.toDate);
						}),
						datasets: [{
							data: mileage.map(function(entry) {
								if(entry.gallons == 0) {
									return null;
								}
								return Math.round(10.0 * entry.tripMileage / entry.gallons) / 10.0;
							}),
							label: "MPG",
							yAxisID: "mpgAxis",
							fill: false,
							borderColor: "#f00",
							backgroundColor: "#d00"
						}, {
							data: mileage.map(function(entry) {
								if(entry.tripMileage == 0) {
									return null;
								}
								return Math.round( 1000.0 * (entry.gallons * entry.pricePerGallon) / entry.tripMileage) / 1000.0;
							}),
							label: "PPM",
							yAxisID: "ppmAxis",
							fill: false,
							borderColor: "#00f",
							backgroundColor: "#00d"
						}]
					},
					options: {
						scales: {
							xAxes: [{
								time: [{
									unit: 'month'
								}],
								position: "bottom",
								scaleLabel: {
									display: true,
									labelString: "Date"
								},
								display: false
							}],
							yAxes: [{
								"id": "mpgAxis",
								position: "left",
								scaleLabel: {
									display: true,
									labelString: "MPG (mi/gal)"
								}
							}, {
								"id": "ppmAxis",
								position: "right",
								scaleLabel: {
									display: true,
									labelString: "PPM ($/mi)"
								}
							}]
						}
					}
				});

				totalEA = mileage.reduce(function(acc, entry) { return acc + entry.pricePerGallon * entry.gallons }, 0.0);
				totalMileage = mileage.reduce(function(acc, entry) { return acc + entry.tripMileage }, 0.0);
				totalGallons = mileage.reduce(function(acc, entry) { return acc + entry.gallons }, 0.0);

				totalEA = Math.round(100.0 * totalEA) / 100.0
				totalMileage = Math.round(totalMileage)
				totalGallons = Math.round(totalGallons)

				new Vue({
					el: "#mileage",
					data : {
						entries : mileage,
						totalEA : totalEA,
						totalMileage : totalMileage,
						totalGallons : totalGallons
					}
				});

				$(".editableRow")
					.mouseenter(function() {
						$(this).find(".edit").show();
						$(this).find(".remove").show();
					})
					.mouseleave(function() {
						$(this).find(".edit").hide();
						$(this).find(".remove").hide();
					});

				$(".edit").colorbox({
					inline: true,
					onLoad: function() {
						$(this).html("Hello world!");
					},
					onClosed : function() {
						location.reload();
					}
				});

				$(".remove").click(function(e) {
					e.preventDefault();

					var confirmed = confirm("Are you sure you want to remove this record?");
					if(!confirmed) {
						return;
					}

					$.ajax({
						method : "DELETE",
						url : "/rest/mileage",
						success : function(result) {

						},
						fail : function(result) {

						}
					});
				});

			},
			fail : function() {
				$("#messageBox").text("Failed to load mileage information");
			}
		});

		$.ajax({
			url : "rest/providers",
			timeout: 3000,
			success : function(providers) {
				providerSelect = $("#providerId");
				for(var i = 0, len = providers.length; i < len; ++i) {
					$("<option value=\"" + providers[i].id + "\">" + providers[i].name + "</option>").appendTo(providerSelect);
				}
			}
		});

		$.ajax({
			url : "rest/destinations",
			timeout: 3000,
			success : function(destinations) {
				destSelect = $("#destinationId");
				for(var i = 0, len = destinations.length; i < len; ++i) {
					$("<option value=\"" + destinations[i].id + "\">" + destinations[i].name + "</option>").appendTo(destSelect);
				}
			}
		});
	});
  </script>

  <div class="container showgrid">
    <div class="span-4">
      <h1>Car Log</h1>
    </div>
    <div class="span-20 last" style="text-align:right;">
      <a href="">Vehicles</a> | <a href="">Settings</a>
    </div>
  </div>

  <div class="container">
    <div class="span-18">
      <a href="index.html">Dashboard</a> | <a href="mileage.html">Mileage</a> | <a href="maintenance.html">Maintenance</a> | <a href="events.html">Events</a>
    </div>

    <div class="span-6 last" style="text-align:right;">
      <a id="exportCsv" href=""><img src="img/fugue/document-excel-csv.png" /> Export CSV</a> 
    | <a id="addEntry" href="#mileageForm"><img src="img/fugue/plus-circle.png" /> Add Entry</a>
    </div>

    <div id="messageBox" class="span-24 last"></div>

    <canvas id="mileageChart" width="925" height="325"></canvas>

    <div id="mileage" class="span-24 last">
      <table>
        <thead>
          <tr>
            <th></th>
            <th>From</th>
            <th>To</th>
            <th>Trip (mi)</th>
            <th>Fuel (gal)</th>
            <th>PPG ($/gal)</th>
            <th>EA ($)</th>
            <th>MPG (mi/gal)</th>
            <th>PPM ($/mi)</th>
            <th></th>
          </tr>
        </thead>
        <tbody>
          <tr class="editableRow" v-for="entry in entries">
            <td style="width:16px;"><a class="edit" v-bind:href="'/rest/mileage/' + entry.id" style="display:none;"><img src="img/fugue/pencil.png" /></a></td>
            <td>{{ entry.fromDate }}</td>
            <td>{{ entry.toDate }}</td>
            <td>{{ entry.tripMileage }}</td>
            <td>{{ entry.gallons }}</td>
            <td>{{ entry.pricePerGallon }}</td>
            <td>{{ (Math.round(100.0 * entry.gallons * entry.pricePerGallon) / 100.0) }}</td>
            <td>{{ (Math.round(10.0 * entry.tripMileage / entry.gallons) / 10.0) }}</td>
            <td>{{ (Math.round(1000.0 * entry.gallons * entry.pricePerGallon / entry.tripMileage) / 1000.0) }}</td>
            <td style="width:16px;"><a class="remove" v-bind:href="'/rest/mileage/' + entry.id" style="display:none;"><img src="img/fugue/minus-circle.png" /></a></td>
          </tr>
        </tbody>
        <tfoot>
        </tfoot>
      </table>
    </div>
  </div>

  <div style="display:none;">
    <div id="mileageForm" style="padding: 10px; background:#fff;">
      <div id="formMessageBox" style="display:block;"></div>

      <form>
        <fieldset>
          <legend>Record Mileage</legend>
          <table class="grid">
            <tr>
              <td><label for="fromDate">From</label></td>
              <td><input name="fromDate" id="fromDate" type="date" /></td>
            </tr>
            <tr>
              <td><label for="toDate">To</label></td>
              <td><input name="toDate" id="toDate" type="date" /></td>
            </tr>
            <tr>
              <td><label for="tripMileage">Trip Mileage</label></td>
              <td><input name="tripMileage" id="tripMileage" type="number" /></td>
            </tr>
            <tr>
              <td><label for="totalMileage">Odometer</label></td>
              <td><input name="totalMileage" id="totalMileage" type="number" /></td>
            </tr>
            <tr>
              <td><label for="gallons">Gallons</label></td>
              <td><input name="gallons" id="gallons" type="number" /></td>
            </tr>
            <tr>
              <td><label for="pricePerGallon">Price Per Gallon</label></td>
              <td><input name="pricePerGallon" id="pricePerGallon" type="number" /> </td>
            </tr>
            <tr>
              <td><label for="providerId">Gas Station</label></td>
              <td>
                <select id="providerId" name="providerId">
                  <option value="0">New Gas Station...</option>
                </select>
              </td>
            </tr>
            <tr>
              <td><label for="destinationId">Destination</label></td>
              <td>
                <select id="destinationId" name="destinationId">
                  <option value="0">New Destination...</option>
                </select>
              </td>
            </tr>
          </table>
          <input name="vehicleId" id="vehicleId" type="hidden" value="1" />
        </fieldset>
        <div style="text-align: right;">
          <a class="submit" href="rest/mileage">Submit</a>
        </div>
      </form> 
    </div>
  </div>
</html>
